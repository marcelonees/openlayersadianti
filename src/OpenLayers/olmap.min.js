var geoserver_url="https://geo.jaraguadosul.sc.gov.br/gs/geoserver-hive/PMJS/wms?";var view=map.getView();view.animate({center:ol.proj.fromLonLat([lng,lat]),zoom:14});var HoverImoveisFeatures=[];var HighlightImoveisSource=new ol.source.Vector({format:new ol.format.GeoJSON});var HighlightImoveisLayer=new ol.layer.Vector({source:HighlightImoveisSource,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0,0,0,0)",width:1}),fill:new ol.style.Fill({color:"rgba(0,0,0,0)"})})});HighlightImoveisLayer.setZIndex(7);map.addLayer(HighlightImoveisLayer);function limparOverlays(){map.addOverlay(Imov_Popup)}var Imov_Popup=new Popup({width:"350px"});map.addOverlay(Imov_Popup);var HighlightGeomSource=new ol.source.Vector({format:new ol.format.GeoJSON});var HighlightGeomStyle=new ol.style.Style({stroke:new ol.style.Stroke({color:strokeColor,width:3}),fill:new ol.style.Fill({color:fillColor})});var HighlightGeomLayer2=new ol.layer.Vector({source:HighlightGeomSource,style:function(){var defaultStyle=[new ol.style.Style({fill:new ol.style.Fill({color:"navy"}),stroke:new ol.style.Stroke({color:"black",width:1})})];var ruleStyle=[new ol.style.Style({fill:new ol.style.Fill({color:"olive"}),stroke:new ol.style.Stroke({color:"black",width:1})})];return function(feature,resolution){if(feature.get("class")=="A"){return ruleStyle}else{return defaultStyle}}}()});var HighlightGeomLayer=new ol.layer.Vector({source:HighlightGeomSource,style:function(){var stroke=new ol.style.Stroke({color:"black"});var textStroke=new ol.style.Stroke({color:"#fff",width:3});var textFill=new ol.style.Fill({color:"#000"});return function(feature,resolution){control=feature.get("control");if(control=="VigEpiMinhasAtividades"){logradouro=feature.get("logradouro");logradouro_num=feature.get("logradouro_num");bairro=feature.get("bairro");quarteirao=feature.get("quarteirao");text=logradouro_num;textStyle=new ol.style.Text({font:"10px Calibri,sans-serif",text:text,fill:textFill,stroke:textStroke});classe=feature.get("class");switch(classe){case"A":return new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(87,213,87,1)"}),text:textStyle});break;case"I":return new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(204,229,255,1)"}),text:textStyle});break;case"F":return new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(226,227,229,1)"}),text:textStyle});break;default:return new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(244,67,54,1)"}),text:textStyle})}}else{return new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(44,88,55,0.4)"}),text:new ol.style.Text({font:"10px Calibri,sans-serif",fill:textFill,stroke:textStroke})})}}}()});HighlightGeomLayer.setZIndex(7);map.addLayer(HighlightGeomLayer);function configStroke(strokeColor,fillColor){HighlightGeomLayer.setStyle([new ol.style.Style({stroke:new ol.style.Stroke({color:strokeColor,width:3}),fill:new ol.style.Fill({color:fillColor})})])}function addLayer(layerName,sourceType="OSM",attributions=NULL,sourceUrl=NULL,minZoom=8,maxZoom=19){console.log("função addLayer")}function DrawCircleOnLonLat(lon,lat,radius){var circle=new ol.geom.Circle(ol.proj.transform([lon,lat],"EPSG:4326","EPSG:3857"),radius);var CircleFeature=new ol.Feature(circle);var vectorSource=new ol.source.Vector({projection:"EPSG:4326"});vectorSource.addFeatures([CircleFeature]);var circleLayer=new ol.layer.Vector({source:vectorSource,style:[new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(255,15,15)",width:3}),fill:new ol.style.Fill({color:"rgba(255,15,15, 0.1)"})})]});map.addLayer(circleLayer)}function clearGeomSource(){console.log("clearGeomSource");HighlightGeomSource.clear()}function HighlightGeom(geom){HighlightGeomSource.addFeatures((new ol.format.GeoJSON).readFeatures(geom,{featureProjection:"EPSG:3857"}))}function HighlightAndFlyToGeom(geom,zoom){HighlightGeom(geom);const centroid=turf.centroid(geom);const centroidproj=ol.proj.fromLonLat(centroid.geometry.coordinates);flyTo(centroidproj,zoom)}function centroidOfGeom(geom){const centroid=turf.centroid(geom);lon=centroid.geometry.coordinates[0];lat=centroid.geometry.coordinates[1];if(document.getElementById("lat")){document.getElementById("lat").value=lat}if(document.getElementById("lon")){document.getElementById("lon").value=lon}return centroid.geometry.coordinates}function flyTo(location,zoom=null,done){var duration=1500;var parts=2;var fitafter=false;if(zoom==null){var ext=ol.extent.createEmpty();ol.extent.extend(ext,HighlightGeomSource.getExtent());zoom=15;fitafter=true}var called=false;function callback(complete){--parts;if(called){return}if(parts===0||!complete){called=true}}view.animate({center:location,duration:duration},callback);view.animate({zoom:zoom-1,duration:duration/2},{zoom:zoom,duration:duration/2},callback);if(fitafter){map.getView().fit(ext,map.getSize())}}function addNode(node){switch(node.data.layer_type){case"wms":addWMSLayer(node);break;case"raster-XYZtiles":addXYZTileLayer(node);break;case"blank":break;case"vector-XYZtiles":addXYZVectorLayer(node);break;default:}}function removeNode(node){switch(node.data.layer_type){case"wms":removeWMSLayer(node);break;case"raster-XYZtiles":removeXYZTileLayer(node);case"blank":break;case"vector-XYZtiles":removeXYZVectorLayer(node);break;default:}}function addWMSLayer(node){var WMSLayer=new ol.layer.Tile({name:node.key,source:new ol.source.TileWMS({url:node.data.source_url,params:{layers:node.data.lyr,TILED:true,tiled:true,TRANSPARENT:true,srs:"EPGS:3857",STYLES:node.data.layer_styles},serverType:"geoserver",crossOrigin:"anonymous"})});WMSLayer.setZIndex(node.data.pane);map.addLayer(WMSLayer)}function removeWMSLayer(node){const layersToRemove=[];map.getLayers().forEach(function(layer){if(layer.get("name")!=undefined&&layer.get("name")===node.key){layersToRemove.push(layer)}});if(layersToRemove.length>=1){map.removeLayer(layersToRemove[0])}}function addXYZTileLayer(node){var XYZTileLayer=new ol.layer.Tile({name:node.key,maxZoom:node.data.maxzoom||18,source:new ol.source.XYZ({url:node.data.source_url,crossOrigin:"anonymous",maxZoom:node.data.maxzoom||18,tileSize:node.data.tileSize||256})});XYZTileLayer.setZIndex(node.data.pane);map.addLayer(XYZTileLayer)}function removeXYZTileLayer(node){const layersToRemove=[];map.getLayers().forEach(function(layer){if(layer.get("name")!=undefined&&layer.get("name")===node.key){layersToRemove.push(layer)}});if(layersToRemove.length>=1){map.removeLayer(layersToRemove[0])}}function addXYZVectorLayer(node){var XYZVectorLayer=new ol.layer.VectorTile({name:node.key,declutter:true,source:new ol.source.VectorTile({url:node.data.source_url,format:new ol.format.MVT,crossOrigin:"anonymous"})});XYZVectorLayer.setZIndex(node.data.pane);map.addLayer(XYZVectorLayer);fetch(node.data.style_url).then(function(response){response.json().then(function(glStyle){olms.stylefunction(XYZVectorLayer,glStyle,node.data.style_key)})})}function removeXYZVectorLayer(node){const layersToRemove=[];map.getLayers().forEach(function(layer){if(layer.get("name")!=undefined&&layer.get("name")===node.key){layersToRemove.push(layer)}});if(layersToRemove.length>=1){map.removeLayer(layersToRemove[0])}}function getLoader(){var loader_container=document.createElement("div");loader_container.className="loader-container";var loader_div=document.createElement("div");loader_div.className="csscssload-load-frame";for(var i=0;i<25;i++){var loader=document.createElement("div");loader.className="cssload-dot";loader_div.appendChild(loader)}loader_container.appendChild(loader_div);return loader_container}Mouse_Position=function(opt_options){this.container=document.createElement("div");this.container.classList.add("custom-control");this.container.classList.add("rectangle-medium-ctrl");this.container.classList.add("Mouse-Position-Control");$(this.container).attr("id","mousepositioncontainer");this.lat=0;this.lng=0;$(this.container).css("font-size","11px");ol.control.Control.call(this,{element:this.container});var mousePositionControl=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",target:this.container});map.addControl(mousePositionControl)};Imov_Touch_Control=function(opt_options){this.TouchImovEnabled=false;this.container=document.createElement("div");this.container.classList.add("custom-control");this.container.classList.add("small-ctrl");this.container.classList.add("Imov-Touch-Control");ol.control.Control.call(this,{element:this.container});this.onEnable=function(){disableOtherControls(this.name);this.TouchImovEnabled=true;this.container.classList.add("small-ctrl-extend");map.getViewport().style.cursor="crosshair";map.on("moveend",this.onDragUpdate);map.on("pointermove",this.onHighlightFeature);map.on("singleclick",this.onSingleClick);this.onDragUpdate()};this.onDisable=function(){this.TouchImovEnabled=false;map.getViewport().style.cursor="";this.container.classList.remove("small-ctrl-extend");map.un("moveend",this.onDragUpdate);map.un("pointermove",this.onHighlightFeature);map.un("singleclick",this.onSingleClick);HighlightImoveisSource.clear()};this.onDragUpdate=function(){const geoserver_url="https://geo.jaraguadosul.sc.gov.br/gs/geoserver-hive/PMJS/wms";if(map.getView().getZoom()>16){$.post(geoserver_url,{service:"WFS",request:"GetFeature",typeNames:"lotes",version:"2.0.0",srsName:"EPSG:4326",outputFormat:"application/json",bbox:map.getView().calculateExtent(map.getSize()).join(",")+", EPSG:3857"},function(data){HighlightImoveisSource.addFeatures((new ol.format.GeoJSON).readFeatures(data,{featureProjection:"EPSG:3857"}))})}};this.onHighlightFeature=function(e){var i;var style_highlighted_imovel=new ol.style.Style({stroke:new ol.style.Stroke({color:"#efb800",width:4}),fill:new ol.style.Fill({color:"rgba(249,252,78,0.1)"})});for(i=0;i<HoverImoveisFeatures.length;i++){HoverImoveisFeatures[i].setStyle(null)}HoverImoveisFeatures=[];map.forEachFeatureAtPixel(e.pixel,function(feature){feature.setStyle(style_highlighted_imovel);HoverImoveisFeatures.push(feature)})};this.onSingleClick=function(e){var coordinate=ol.proj.toLonLat(e.coordinate,"EPSG:3857");var el=document.createElement("div");var content=document.createElement("div");el.appendChild(content);content.appendChild(getLoader())}};ol.inherits(Imov_Touch_Control,ol.control.Control);ol.inherits(Mouse_Position,ol.control.Control);Control_Imov_Touch=new Imov_Touch_Control;Control_Mouse_Position=new Mouse_Position;if(typeof CustomControls=="undefined"){var CustomControls={TouchImov:Control_Imov_Touch}}map.addControl(Control_Imov_Touch);map.addControl(Control_Mouse_Position);Control_Imov_Touch.onEnable();function disableOtherControls(controltokeep){for(var control in CustomControls){if(control!=controltokeep){CustomControls[control].onDisable()}}}function addPin(Markers){map.getLayers().getArray().filter(layer=>layer.get("name")==="VLMarker").forEach(function(layer){var source=layer.getSource();map.removeLayer(layer)});var item=Markers;var longitude=item.lng;var latitude=item.lat;var iconFeature=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([longitude,latitude],"EPSG:4326","EPSG:3857"))});var iconStyle=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],src:"vendor/marcelonees/plugins/src/OpenLayers/marker-icon.png"})});iconFeature.setStyle(iconStyle);features.push(iconFeature);var vectorSource=new ol.source.Vector({features:features});vectorLayer=new ol.layer.Vector({source:vectorSource,name:"VLMarker"});map.addLayer(vectorLayer)}function onMapClick(e){lon=e.coordinate[0];lat=e.coordinate[1];lonlat=ol.proj.transform([lon,lat],"EPSG:3857","EPSG:4326");var lon=lonlat[0];var lat=lonlat[1];var f=map.forEachFeatureAtPixel(e.pixel,function(ft,layer){console.log(ft);var coordinate=ol.proj.toLonLat(e.coordinate,"EPSG:3857");var el=document.createElement("div");var content=document.createElement("div");el.appendChild(content);content.appendChild(getLoader());control=ft.geometryChangeKey_.bindTo.values_.control;if(control=="VigEpiMinhasAtividades"){programacao_id=ft.geometryChangeKey_.bindTo.values_.programacao_id;lote_id=ft.geometryChangeKey_.bindTo.values_.lote_id;inscricao_imobiliaria=ft.geometryChangeKey_.bindTo.values_.inscricao_imobiliaria;console.log("VigEpiMinhasAtividades: "+inscricao_imobiliaria);__adianti_ajax_exec("class=VigEpiMinhasAtividades&method=generatePopupStructure&lat="+coordinate[1]+"&lng="+coordinate[0]+"&programacao_id="+programacao_id+"&inscricao_imobiliaria="+inscricao_imobiliaria,function(data){$(content).html(data);Imov_Popup.getElement().addEventListener("click",function(e){if($(e.target).attr("data-toggle")=="tab"){$(e.target).tab("show")}},false)},false);Imov_Popup.show(e.coordinate,el)}else if(!ft.geometryChangeKey_.bindTo.values_.chave){if(document.getElementById("lat")){document.getElementById("lat").value=lat}if(document.getElementById("lon")){document.getElementById("lon").value=lon}var Markers={lat:lat,lng:lon};addPin(Markers)}else{__adianti_ajax_exec("class=VigEpiReconhecimentoGeograficoForm&method=generatePopupStructure&lat="+coordinate[1]+"&lng="+coordinate[0],function(data){$(content).html(data);Imov_Popup.getElement().addEventListener("click",function(e){if($(e.target).attr("data-toggle")=="tab"){$(e.target).tab("show")}},false)},false);Imov_Popup.show(e.coordinate,el)}return ft})}map.on("click",onMapClick);